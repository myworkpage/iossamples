trigger:
  branches:
    include:
      - master
      - feat/*
  paths:
    include:
      - src/app/*
    exclude:
      - src/api/*

variables:
  - name: binFolder
    value: 'src/app/Bcbsla.Mobile.App.IOS/bin/'
  - name: dotNetVersion
    value: 'net9.0-ios'
  - name: architectureType
    value: 'ios-arm64'
  - group: member-mobile-app-ci

jobs:
  - job: IOS_Uat
    pool:
      vmImage: 'macos-15'
    steps:
      - task: PowerShell@2
        displayName: Set Xcode v16.3
        inputs:
          targetType: 'inline'
          script: |
            sudo xcode-select -s /Applications/Xcode_16.3.app
            xcrun xcode-select --print-path

      - task: CmdLine@2
        displayName: Xcode Version
        inputs:
          script: 'xcodebuild -version'

      - task: UseDotNet@2
        inputs:
          useGlobalJson: true

      - task: CmdLine@2
        displayName: Install .NET MAUI for iOS
        inputs:
          script: 'dotnet workload install maui ios --version 9.0.203'

      - task: InstallAppleCertificate@2
        inputs:
          certSecureFile: 'DistributionCertificate.p12'
          certPwd: '$(CertificatePassword)'

      - task: InstallAppleProvisioningProfile@1
        inputs:
          provisioningProfileLocation: 'sourceRepository'
          provProfileSourceRepository: 'src/app/Bcbslax_AdHoc_profile.mobileprovision'
          removeProfile: true

      - task: DotNetCoreCLI@2
        inputs:
          command: 'publish'
          publishWebProjects: false
          projects: 'src/app/Bcbsla.Mobile.App.IOS/Bcbsla.Mobile.App.IOS.csproj'
          arguments: '-c Release_Test -f net9.0-ios /p:ArchiveOnBuild=false /p:EnableAssemblyILStripping=false /p:IsPublishing=true'

      - task: CopyFiles@2
        inputs:
          SourceFolder: '$(agent.builddirectory)'
          Contents: '**/*.ipa'
          TargetFolder: '$(build.artifactstagingdirectory)/UAT'
          flattenFolders: true

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: $(system.defaultWorkingDirectory)/$(binFolder)/Release_Test/$(dotNetVersion)/$(architectureType)/Bcbsla.Mobile.App.IOS.app.dSYM
          archiveType: 'zip'
          archiveFile: '$(Build.ArtifactStagingDirectory)/UAT/Bcbsla.Mobile.App.IOS.app.dSYM.UAT-$(Build.BuildId).zip'
          verbose: true
          
      # Install Firebase CLI
      - task: Bash@3
        displayName: Install Firebase CLI
        inputs:
          targetType: 'inline'
          script: |
            curl -sL https://firebase.tools | bash

      - task: Bash@3
        displayName: Debug IPA Path
        inputs:
          targetType: 'inline'
          script: |
            echo "Looking in build directory:"
            find "$(System.DefaultWorkingDirectory)" -type f -name "*.ipa"

      # Upload to Firebase App Distribution
      - task: Bash@3
        displayName: Upload to Firebase UAT
        inputs:
          targetType: 'inline'
          script: |
            export FIREBASE_TOKEN=$(FirebaseToken_UAT)

            if [ -z "$FIREBASE_TOKEN" ]; then
              echo "Firebase token is missing!"
              exit 1
            fi

            firebase appdistribution:distribute "$(Build.ArtifactStagingDirectory)/UAT/Bcbsla.Mobile.App.IOS.ipa" \
              --app "1:658107755795:ios:0a47d2f3e85903eb273ee6" \
              --release-notes "Automated UAT CI Build $(Build.BuildId)" \
              --groups "uat_qa" \
              --token "$FIREBASE_TOKEN"    

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/UAT'
          ArtifactName: 'drop_uat'
          publishLocation: 'Container'
